<openapi-spec-template>

<purpose>
Template and guidance for generating OpenAPI 3.0 specifications from API routes.
Used by /sensei:generate-specs to create machine-readable API documentation.
</purpose>

<detection_patterns>
## Route Detection Patterns

Identify API routes in common frameworks:

### Express.js
```javascript
router.get('/users', handler)
router.post('/users', handler)
app.get('/api/v1/products', handler)
```

### Fastify
```javascript
fastify.get('/users', handler)
fastify.route({ method: 'GET', url: '/users', handler })
```

### Hono
```javascript
app.get('/users', handler)
app.post('/users', handler)
```

### Next.js App Router
```
app/api/users/route.ts → GET, POST handlers
app/api/users/[id]/route.ts → Dynamic route
```

### Next.js Pages Router
```
pages/api/users.ts → default export
pages/api/users/[id].ts → Dynamic route
```
</detection_patterns>

<extraction_rules>
## Information Extraction

### From Route Definition
- HTTP method (GET, POST, PUT, PATCH, DELETE)
- Path with parameters (/users/:id → /users/{id})
- Route grouping (auth, users, products)

### From Handler/Controller
- Request body schema (from validation or TypeScript types)
- Query parameters (from req.query usage)
- Path parameters (from req.params usage)
- Response shape (from return statements or response calls)

### From Middleware
- Authentication requirements (auth middleware present)
- Rate limiting (rate limit middleware)
- Validation schemas (zod, yup, joi)

### From Comments/JSDoc
```javascript
/**
 * @summary Create a new user
 * @description Creates a user account with email and password
 * @tags Users
 */
```
</extraction_rules>

<output_template>
## OpenAPI 3.0 Specification Template

```yaml
openapi: 3.0.0
info:
  title: {project_name} API
  description: |
    {project_description}

    Auto-generated by BuildSensei from source code analysis.
  version: {version}
  contact:
    name: API Support
  license:
    name: MIT

servers:
  - url: http://localhost:{port}
    description: Development server
  - url: https://api.{domain}
    description: Production server

tags:
  - name: {tag_name}
    description: {tag_description}

paths:
  {path}:
    {method}:
      summary: {summary}
      description: {description}
      operationId: {operationId}
      tags:
        - {tag}
      security:
        - bearerAuth: []  # If auth required
      parameters:
        - name: {param_name}
          in: {path|query|header}
          required: {true|false}
          schema:
            type: {type}
          description: {description}
      requestBody:
        required: {true|false}
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/{SchemaName}'
      responses:
        '200':
          description: {success_description}
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/{ResponseSchema}'
        '400':
          description: Bad request
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized
        '404':
          description: Not found
        '500':
          description: Internal server error

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
    apiKey:
      type: apiKey
      in: header
      name: X-API-Key

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
        message:
          type: string
        code:
          type: string
      required:
        - error
        - message

    {SchemaName}:
      type: object
      properties:
        {property_name}:
          type: {string|number|boolean|array|object}
          description: {description}
          format: {email|date-time|uuid|uri}
          example: {example_value}
      required:
        - {required_field}
```
</output_template>

<file_organization>
## Output File Structure

```
docs/spec/api/
├── index.yaml           # Combined spec (imports all)
├── auth.yaml            # Authentication endpoints
├── users.yaml           # User management endpoints
├── {resource}.yaml      # One file per resource/tag
└── schemas/
    ├── common.yaml      # Shared schemas (Error, Pagination)
    └── {resource}.yaml  # Resource-specific schemas
```

### Index File Pattern
```yaml
# docs/spec/api/index.yaml
openapi: 3.0.0
info:
  title: {project_name} API
  version: {version}

paths:
  $ref: './auth.yaml#/paths'
  $ref: './users.yaml#/paths'

components:
  schemas:
    $ref: './schemas/common.yaml#/components/schemas'
```
</file_organization>

<type_mapping>
## TypeScript to OpenAPI Type Mapping

| TypeScript | OpenAPI | Format |
|------------|---------|--------|
| string | string | - |
| number | number | - |
| boolean | boolean | - |
| Date | string | date-time |
| string (email) | string | email |
| string (uuid) | string | uuid |
| string (url) | string | uri |
| Array<T> | array | items: T |
| Record<string, T> | object | additionalProperties: T |
| T \| null | nullable: true | - |
| T \| undefined | required: false | - |
| enum | enum | - |

### Zod to OpenAPI
```typescript
z.string() → type: string
z.string().email() → type: string, format: email
z.number().min(0).max(100) → type: number, minimum: 0, maximum: 100
z.enum(['a', 'b']) → type: string, enum: ['a', 'b']
z.object({...}) → type: object, properties: {...}
z.array(z.string()) → type: array, items: { type: string }
```
</type_mapping>

<validation_rules>
## Spec Validation

After generation, validate:

1. **All paths have responses** - At least 200 and one error
2. **All schemas referenced exist** - No dangling $refs
3. **All required fields marked** - Based on validation schemas
4. **Examples provided** - For complex schemas
5. **Tags consistent** - All paths tagged, tags defined
6. **Security applied** - Auth routes have security schemes

### Validation Command
```bash
# Using spectral or similar
npx @stoplight/spectral-cli lint docs/spec/api/index.yaml
```
</validation_rules>

</openapi-spec-template>
