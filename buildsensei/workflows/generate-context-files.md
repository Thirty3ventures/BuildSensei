<generate-context-files-workflow>

<purpose>
Workflow for generating initial context files (CLAUDE.md, spec.md, PRD.md, etc.)
at appropriate stages of the BuildSensei project lifecycle.
</purpose>

<when_to_use>
Called by various commands at specific triggers:
- new-project → CLAUDE.md skeleton
- define-requirements → spec.md
- create-roadmap → PRD.md, update spec.md timeline
- complete-milestone → agents.md, finalize all
</when_to_use>

<required_reading>
@templates/context-files/claude-md.md
@templates/context-files/spec-md.md
@templates/context-files/prd-md.md
@templates/context-files/agents-md.md
@templates/context-files/skills-md.md
@templates/context-files/references-md.md
</required_reading>

<generation_functions>

<function name="generate_claude_md_skeleton">
## Generate CLAUDE.md Skeleton

**Trigger:** After /sensei:new-project completes

**Inputs:**
- PROJECT.md content
- User's tech stack answers
- Project constraints

**Process:**

1. Read PROJECT.md:
   ```bash
   cat .planning/PROJECT.md
   ```

2. Extract key information:
   - Project name and description
   - Core value statement
   - Tech stack (if specified)
   - Constraints (becomes "Do Not" section)

3. Generate skeleton:

```markdown
# CLAUDE.md - Project Context

<!--
  AUTO-GENERATED by BuildSensei v{version}
  Last updated: {timestamp}
  Current phase: Not started

  This file persists project knowledge across sessions.
-->

## Project Overview

{project_name}: {description}

**Core Value:** {core_value}

## Tech Stack

| Layer | Technology | Notes |
|-------|------------|-------|
| Frontend | {frontend or "TBD"} | |
| Backend | {backend or "TBD"} | |
| Database | {database or "TBD"} | |
| Hosting | {hosting or "TBD"} | |

## File Structure

<!-- Will be populated as project builds or via /sensei:map-codebase -->

```
{project_root}/
├── src/
├── tests/
├── .planning/
└── ...
```

## Key Decisions

<!-- Decisions will be added as phases complete -->

| Decision | Choice | Rationale | Phase |
|----------|--------|-----------|-------|

## Naming Conventions

<!-- Will be populated from codebase analysis or as patterns emerge -->

- **Components:** PascalCase
- **Functions:** camelCase
- **Files:** kebab-case
- **Constants:** SCREAMING_SNAKE_CASE

## Do Not

{constraints_as_bullets}

## Gotchas Discovered

<!-- Will be populated as phases complete -->

## Patterns Discovered

<!-- Will be populated as phases complete -->

## Key Files

<!-- Will be populated as phases complete -->

| File | Purpose | Phase Added |
|------|---------|-------------|

## Agent Responsibilities

<!-- Will be populated at milestone completion -->

See agents.md (will be generated after first milestone)

## Current Sprint Context

**Current Phase:** Phase 1 (not started)
**Focus:** {first_phase_goal or "Planning"}
**Blockers:** None

## Session Continuity

**Last Session:** {timestamp}
**Completed:** Project initialized
**Next Up:** /sensei:define-requirements or /sensei:create-roadmap

---
<!-- METADATA -->
<!--
  buildsensei_version: {version}
  user_edited: false
  generation_count: 1
  phases_incorporated: []
-->
```

4. Write file:
   ```bash
   echo "$CONTENT" > CLAUDE.md
   ```

5. Create empty companion files:
   ```bash
   touch skills.md references.md
   ```
</function>

<function name="generate_spec_md">
## Generate spec.md

**Trigger:** After /sensei:define-requirements completes

**Inputs:**
- PROJECT.md
- REQUIREMENTS.md

**Process:**

1. Read requirements:
   ```bash
   cat .planning/REQUIREMENTS.md
   ```

2. Parse requirements by scope:
   - v1 (MVP) requirements
   - v2+ (Future) requirements
   - Out of scope

3. Generate spec.md:

```markdown
# spec.md - Product Specification

<!--
  AUTO-GENERATED by BuildSensei v{version}
  Last updated: {timestamp}
  Source: .planning/REQUIREMENTS.md
-->

## Product Vision

{from PROJECT.md "What This Is"}

## User Problem

{from requirements gathering or PROJECT.md}

## Target Users

{from PROJECT.md or "TBD"}

## Core Features (MVP - v1)

{for each v1 requirement:}
### {requirement_id}: {requirement_name}

**Status:** Pending
**Phase:** TBD (assigned during roadmap creation)

**Description:**
{requirement_description}

**Acceptance Criteria:**
{acceptance_criteria_as_checkboxes}

---

## Non-Goals (Not Building in v1)

{out_of_scope_requirements}

## Future Considerations (v2+)

{v2_requirements}

## Tech Decisions

| Decision | Choice | Alternatives | Rationale |
|----------|--------|--------------|-----------|
{from PROJECT.md constraints}

## Timeline

<!-- Will be populated after /sensei:create-roadmap -->

| Phase | Goal | Features | Status |
|-------|------|----------|--------|

## Success Metrics

{from requirements or "TBD"}

---
<!-- METADATA -->
<!--
  buildsensei_version: {version}
  requirements_source: .planning/REQUIREMENTS.md
  features_complete: 0/{total_count}
-->
```

4. Write file and update CLAUDE.md with link
</function>

<function name="generate_prd_md">
## Generate PRD.md

**Trigger:** After /sensei:create-roadmap completes

**Inputs:**
- PROJECT.md
- REQUIREMENTS.md
- ROADMAP.md

**Process:**

1. Read all planning documents

2. Generate PRD.md:

```markdown
# PRD.md - Product Requirements Document

<!--
  AUTO-GENERATED by BuildSensei v{version}
  Last updated: {timestamp}
-->

## Executive Summary

{project_name} is {project_description}.

The core value proposition is: {core_value}

This document outlines the product requirements, timeline, and success criteria
for the {milestone_name or "v1.0"} release.

## Problem Statement

### The Problem
{from PROJECT.md or requirements}

### Who Has This Problem
{target users}

### Current Solutions & Their Gaps
{competitive context if available, otherwise "TBD"}

## Solution

### Our Approach
{solution description from PROJECT.md}

### Key Differentiators
{what makes this different}

### How It Works
{high-level user flow}

## Feature Set

### MVP (v1.0)

{for each phase in roadmap:}
#### Phase {N}: {phase_name}
{phase_goal}

Features included:
{features_in_phase}

---

### Future Roadmap
{v2+ features}

## Timeline & Milestones

| Phase | Goal | Target | Status |
|-------|------|--------|--------|
{from ROADMAP.md}

## Success Metrics

{success metrics from requirements}

## Technical Overview

### Tech Stack
{from PROJECT.md or CLAUDE.md}

### Architecture
{high-level architecture if available}

---
<!-- METADATA -->
<!--
  buildsensei_version: {version}
  milestone: {milestone_name}
-->
```

3. Update spec.md timeline section with roadmap data

4. Write files
</function>

<function name="generate_agents_md">
## Generate agents.md

**Trigger:** After /sensei:complete-milestone

**Inputs:**
- PROJECT.md (project type)
- CLAUDE.md (tech stack)
- Completed phases (what was built)

**Process:**

1. Determine project type:
   - Frontend-heavy → suggest design-agent
   - API-focused → suggest api-agent
   - Full-stack → suggest multiple agents
   - Data-heavy → suggest data-agent

2. Generate agents.md with:
   - Core agents (always included)
   - Project-specific agents (based on type)
   - Context references
   - Usage examples

3. Update CLAUDE.md agent responsibilities section

4. Write file
</function>

<function name="finalize_context_files">
## Finalize All Context Files

**Trigger:** /sensei:complete-milestone

**Process:**

1. Run final extract-knowledge for any unprocessed phases

2. Update CLAUDE.md:
   - Mark milestone complete
   - Summarize all knowledge
   - Update session continuity for next milestone

3. Update spec.md:
   - Mark all v1 features as complete
   - Add "Shipped" date

4. Update PRD.md:
   - Add outcomes section
   - Update status to "Shipped"

5. Generate agents.md if not exists

6. Commit all finalized context files:
   ```bash
   git add CLAUDE.md spec.md PRD.md agents.md skills.md references.md
   git commit -m "docs(context): Finalize context files for {milestone}

   Milestone {milestone} complete. All context files finalized.

   Co-Authored-By: BuildSensei <noreply@buildsensei.dev>"
   ```
</function>

</generation_functions>

<update_functions>

<function name="update_spec_feature_status">
## Update Feature Status in spec.md

**Trigger:** After each phase execution

**Process:**

1. Read spec.md
2. Find features associated with completed phase
3. Update status: "Pending" → "In Progress" → "Complete"
4. Check acceptance criteria boxes
5. Write updated spec.md
</function>

<function name="update_claude_md_sprint_context">
## Update Sprint Context in CLAUDE.md

**Trigger:** After each phase execution

**Process:**

1. Read STATE.md for current position
2. Update "Current Sprint Context" section
3. Update "Session Continuity" section
4. Write updated CLAUDE.md
</function>

</update_functions>

<safety_rules>
## Safety Rules

1. **Never overwrite user edits:**
   - Check for USER_EDITED marker
   - If found, append only to designated sections
   - Never regenerate protected content

2. **Always backup before write:**
   ```bash
   cp {file} .planning/backups/{file}.{timestamp}
   ```

3. **Validate before write:**
   - Content is not empty
   - Required sections exist
   - No obvious corruption

4. **Atomic writes:**
   - Write to temp file first
   - Verify success
   - Move to final location

5. **Git integration:**
   - Stage only context files
   - Never force push
   - Descriptive commit messages
</safety_rules>

</generate-context-files-workflow>
